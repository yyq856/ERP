<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="webserver.mapper.QuotationMapper">

    <!-- 查询询价单 -->
    <select id="selectInquiryById" parameterType="string" resultType="webserver.pojo.InquiryDTO">
        SELECT
            inquiry_id AS inquiryId,
            cust_id AS custId,
            inquiry_type AS inquiryType,
            sls_org AS slsOrg,
            sales_district AS salesDistrict,
            division,
            sold_tp AS soldTp,
            ship_tp AS shipTp,
            cust_ref AS custRef,
            customer_reference_date AS customerReferenceDate,
            valid_from_date AS validFromDate,
            valid_to_date AS validToDate,
            probability,
            net_value AS netValue,
            status
        FROM erp_inquiry
        WHERE inquiry_id = #{inquiryId}
    </select>

    <!-- 查询询价单明细 - 使用统一的erp_item表 -->
    <select id="selectInquiryItemsById" parameterType="string" resultType="webserver.pojo.InquiryItemDTO">
        SELECT
            document_id AS inquiryId,
            item_no AS itemNo,
            mat_id AS matId,
            quantity,
            net_price AS netPrice,
            item_value AS itemValue,
            plant_id AS plantId,
            su,
            item_code AS itemCode,
            material_code AS materialCode,
            order_quantity_str AS orderQuantityStr,
            order_quantity_unit AS orderQuantityUnit,
            description,
            req_deliv_date AS reqDelivDate,
            net_value_str AS netValueStr,
            net_value_unit AS netValueUnit,
            tax_value_str AS taxValueStr,
            tax_value_unit AS taxValueUnit,
            pricing_date AS pricingDate,
            order_probability AS orderProbability,
            pricing_elements_json AS pricingElementsJson
        FROM erp_item
        WHERE document_id = #{inquiryId} AND document_type = 'inquiry'
        ORDER BY item_no
    </select>

    <!-- 插入报价单 -->
    <insert id="insertQuotationFromInquiry" parameterType="webserver.pojo.InquiryDTO">
        INSERT INTO erp_quotation (
            reference_inquiry_id, cust_id, inquiry_type, sls_org, sales_district, division,
            sold_tp, ship_tp, cust_ref, customer_reference_date, valid_from_date, valid_to_date,
            probability, net_value, status, currency
        ) VALUES (
                     #{inquiryId}, #{custId}, #{inquiryType}, #{slsOrg}, #{salesDistrict}, #{division},
                     #{soldTp}, #{shipTp}, #{custRef}, #{customerReferenceDate}, #{validFromDate}, #{validToDate},
                     #{probability}, #{netValue}, 'NEW', 'USD'
                 )
    </insert>

    <!-- 批量插入报价单明细 - 使用统一的erp_item表 -->
    <insert id="insertQuotationItemsFromInquiry">
        INSERT INTO erp_item (
            document_id, document_type, item_no, mat_id, quantity, net_price,
            item_value, plant_id, su, item_code, material_code, order_quantity_str,
            order_quantity_unit, description, req_deliv_date, net_value_str,
            net_value_unit, tax_value_str, tax_value_unit, pricing_date,
            order_probability, pricing_elements_json
        ) VALUES
        <foreach collection="items" item="item" separator=",">
            (
                #{quotationId}, 'quotation', #{item.itemNo}, #{item.matId}, #{item.quantity}, #{item.netPrice},
                #{item.itemValue}, #{item.plantId}, #{item.su}, #{item.itemCode}, #{item.materialCode},
                #{item.orderQuantityStr}, #{item.orderQuantityUnit}, #{item.description}, #{item.reqDelivDate},
                #{item.netValueStr}, #{item.netValueUnit}, #{item.taxValueStr}, #{item.taxValueUnit},
                #{item.pricingDate}, #{item.orderProbability}, #{item.pricingElementsJson}
            )
        </foreach>
    </insert>

    <!-- 获取最后插入的ID -->
    <select id="getLastInsertId" resultType="long">
        SELECT LAST_INSERT_ID()
    </select>

</mapper>
